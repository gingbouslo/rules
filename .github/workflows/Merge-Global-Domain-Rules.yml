name: 合并!cn域名

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # 每天 06:00 UTC 自动执行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Checkout upstream meta-rules-dat
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: meta
          path: upstream

      - name: Merge foreign YAML rule files (fixed)
        shell: bash
        run: |
          set -euo pipefail

          SRC="upstream/geo/geosite"
          DST="update"
          OUT_YAML="${DST}/foreign_domain.yaml"
          OUT_LIST="${DST}/foreign_domain_files.txt"

          echo "Ensure dst exists: $DST"
          mkdir -p "$DST"

          # exact list
          EXACT_LIST=(
            "gfw.yaml" "google.yaml" "youtube.yaml" "tiktok.yaml" "onedrive.yaml" "github.yaml"
            "telegram.yaml" "facebook.yaml" "twitter.yaml" "meta.yaml" "instagram.yaml" "paypal.yaml"
            "reddit.yaml" "netflix.yaml" "discord.yaml" "google-gemini.yaml"

            "steam.yaml" "steamcommunity.yaml" "steampowered.yaml" "epic.yaml" "epicgames.yaml"
            "origin.yaml" "ea.yaml" "uplay.yaml" "ubisoft.yaml" "battlenet.yaml" "blizzard.yaml"
            "rockstar.yaml" "psn.yaml" "xbox.yaml"

            "medium.yaml" "tumblr.yaml" "blogspot.yaml" "blogger.yaml" "wordpress.yaml" "ghost.yaml"
            "substack.yaml" "deviantart.yaml" "pixiv.yaml"

            "binance.yaml" "coinbase.yaml" "kraken.yaml" "blockchain.yaml" "bitfinex.yaml" "okx.yaml"
            "huobi.yaml" "ethereum.yaml" "bitcoin.yaml" "uniswap.yaml"

            "arxiv.yaml" "nature.yaml" "science.yaml" "acm.yaml" "ieee.yaml" "springer.yaml" "jstor.yaml"
            "researchgate.yaml" "pubmed.yaml"

            "nordvpn.yaml" "expressvpn.yaml" "protonvpn.yaml" "surfshark.yaml" "windscribe.yaml"
            "outline.yaml" "lantern.yaml" "psiphon.yaml" "mullvad.yaml"

            "porn.yaml" "pornhub.yaml" "xvideos.yaml" "xnxx.yaml" "xhamster.yaml" "brazzers.yaml"
            "youporn.yaml" "redtube.yaml" "spankbang.yaml" "rule34.yaml"

            "openai.yaml" "anthropic.yaml" "novelai.yaml" "huggingface.yaml" "stability.yaml"
            "midjourney.yaml" "civitai.yaml" "replicate.yaml" "perplexity.yaml"
          )

          # collect files: exact matches OR contains '!cn' AND not contains 'ads'
          tmpfiles=$(mktemp)
          while IFS= read -r -d '' file; do
            base=$(basename "$file")
            add=0
            for name in "${EXACT_LIST[@]}"; do
              if [[ "$base" == "$name" ]]; then
                add=1; break
              fi
            done
            if [[ $add -eq 0 ]]; then
              if [[ "$base" == *"!cn"* && "$base" != *"ads"* ]]; then
                add=1
              fi
            fi
            if [[ $add -eq 1 ]]; then
              printf '%s\0' "$file" >> "$tmpfiles"
            fi
          done < <(find "$SRC" -type f -name "*.yaml" -print0)

          # dedupe
          mapfile -t FILES < <(tr '\0' '\n' < "$tmpfiles" | sort -u)

          # write file list separately
          : > "$OUT_LIST"
          for f in "${FILES[@]}"; do
            echo "$(basename "$f")" >> "$OUT_LIST"
          done

          # construct merged YAML
          : > "$OUT_YAML"
          echo "payload:" >> "$OUT_YAML"

          FIRST=1
          for f in "${FILES[@]}"; do
            sed -n '/^[[:space:]]*#/d; /^[[:space:]]*$/d; /^[[:space:]]*payload:/d; p' "$f" >> "$OUT_YAML"
            FIRST=0
          done

          echo "Merged into: $OUT_YAML"
          echo "List: $OUT_LIST"

      - name: Commit and Push update/
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add update/foreign_domain.yaml update/foreign_domain_files.txt || true
          git commit -m "Update foreign_domain.yaml (merged)" || echo "No changes to commit"
          git push || echo "Push failed or nothing to push"
