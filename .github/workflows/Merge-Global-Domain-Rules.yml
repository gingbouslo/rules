name: Merge GFWPlus Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # 每天 06:00 UTC 自动执行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Checkout upstream meta-rules-dat
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: meta
          path: upstream

      - name: Merge GFWPlus YAML files
        shell: bash
        run: |
          set -euo pipefail

          SRC="upstream/geo/geosite"
          DST="update"
          OUT="${DST}/gfwplus_domain.yaml"

          echo "Merging files into ${OUT}"
          mkdir -p "$DST"

          # 输出头部
          echo "payload:" > "$OUT"
          echo "# merged gfwplus domain rules" >> "$OUT"
          echo >> "$OUT"

          # 完整匹配列表（全部带引号）
          EXACT_LIST=(
            "gfw.yaml" "google.yaml" "youtube.yaml" "tiktok.yaml" "onedrive.yaml" "github.yaml"
            "telegram.yaml" "facebook.yaml" "twitter.yaml" "meta.yaml" "instagram.yaml" "paypal.yaml"
            "reddit.yaml" "netflix.yaml" "discord.yaml"

            "steam.yaml" "steamcommunity.yaml" "steampowered.yaml" "epic.yaml" "epicgames.yaml"
            "origin.yaml" "ea.yaml" "uplay.yaml" "ubisoft.yaml" "battlenet.yaml" "blizzard.yaml"
            "rockstar.yaml" "psn.yaml" "xbox.yaml"

            "medium.yaml" "tumblr.yaml" "blogspot.yaml" "blogger.yaml" "wordpress.yaml" "ghost.yaml"
            "substack.yaml" "deviantart.yaml" "pixiv.yaml"

            "binance.yaml" "coinbase.yaml" "kraken.yaml" "blockchain.yaml" "bitfinex.yaml" "okx.yaml"
            "huobi.yaml" "ethereum.yaml" "bitcoin.yaml" "uniswap.yaml"

            "arxiv.yaml" "nature.yaml" "science.yaml" "acm.yaml" "ieee.yaml" "springer.yaml" "jstor.yaml"
            "researchgate.yaml" "pubmed.yaml"

            "nordvpn.yaml" "expressvpn.yaml" "protonvpn.yaml" "surfshark.yaml" "windscribe.yaml"
            "outline.yaml" "lantern.yaml" "psiphon.yaml" "mullvad.yaml"

            "porn.yaml" "pornhub.yaml" "xvideos.yaml" "xnxx.yaml" "xhamster.yaml" "brazzers.yaml"
            "youporn.yaml" "redtube.yaml" "spankbang.yaml" "rule34.yaml"

            "openai.yaml" "anthropic.yaml" "novelai.yaml" "huggingface.yaml" "stability.yaml"
            "midjourney.yaml" "civitai.yaml" "replicate.yaml" "perplexity.yaml"
          )

          # 收集需要合并的文件
          mapfile -t FILES < <(
            find "$SRC" -type f -name "*.yaml" | while read -r file; do
              base=$(basename "$file")

              # 完整匹配
              for name in "${EXACT_LIST[@]}"; do
                [[ "$base" == "$name" ]] && echo "$file"
              done

              # !cn 且不含 ads
              if [[ "$base" =~ \!cn ]] && [[ ! "$base" =~ ads ]]; then
                echo "$file"
              fi
            done | sort -u
          )

          echo "# merged from files:" >> "$OUT"
          for f in "${FILES[@]}"; do
            echo "# - $(basename "$f")" >> "$OUT"
          done
          echo >> "$OUT"

          FIRST=1
          for f in "${FILES[@]}"; do
            echo "Processing $f"
            if [[ $FIRST -eq 1 ]]; then
              grep -vE '^\s*$' "$f" >> "$OUT"
              FIRST=0
            else
              grep -vE '^\s*$|^payload:' "$f" >> "$OUT"
            fi
          done

      - name: Commit changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          git add update/gfwplus_domain.yaml
          git commit -m "Update gfwplus_domain.yaml" || echo "No changes"
          git push
