name: Mihomo_Rules-set

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current repository (A/B)
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download Mihomo binary
      run: |
        wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz
        gunzip mihomo-linux-amd64-v1.19.17.gz
        chmod +x mihomo-linux-amd64-v1.19.17
        mv mihomo-linux-amd64-v1.19.17 mihomo

    - name: Convert Mihomo Rules (*.yaml → *.mrs)
      run: |
        cd mihomo-rules

        echo "Converting *_domain.yaml → *_domain.mrs ..."
        for file in *_domain.yaml; do
          [ -f "$file" ] || continue
          out="${file%.yaml}.mrs"
          echo "Processing $file → $out"
          ../mihomo convert-ruleset domain yaml "$file" "$out"
        done

        echo "Converting *_ip.yaml → *_ip.mrs ..."
        for file in *_ip.yaml; do
          [ -f "$file" ] || continue
          out="${file%.yaml}.mrs"
          echo "Processing $file → $out"
          ../mihomo convert-ruleset ipcidr yaml "$file" "$out"
        done

    - name: Commit and Push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Action"
        git config user.email "action@github.com"

        git add mihomo-rules/*.mrs
        git commit -m "Update Mihomo MRS (auto-converted)" || echo "No changes."
        git push
