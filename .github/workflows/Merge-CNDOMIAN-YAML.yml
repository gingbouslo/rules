name: 合并cn域名

on:
  workflow_dispatch:   # 仍然可以手动触发
  schedule:
    - cron: '0 22 * * *'  # 每天 UTC 22:00 = 北京时间 6:00

jobs:
  merge-cn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone remote meta-rules-dat repo (sparse checkout geo/geosite)
        run: |
          REMOTE_REPO="https://github.com/MetaCubeX/meta-rules-dat.git"
          REMOTE_BRANCH="meta"
          TEMP_DIR=$(mktemp -d)

          git clone --filter=blob:none --sparse --branch $REMOTE_BRANCH $REMOTE_REPO $TEMP_DIR
          cd $TEMP_DIR
          git sparse-checkout set geo/geosite

          mkdir -p "$GITHUB_WORKSPACE/temp_geo"
          cp -r geo/geosite/* "$GITHUB_WORKSPACE/temp_geo/"

      - name: Merge CN YAML files (preserve original format)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SRC_DIR="temp_geo"
          DST_DIR="update"

          OUTPUT_FILE="$DST_DIR/cnplus_domain.yaml"
          FILE_LIST="$DST_DIR/merged_files.txt"

          mkdir -p "$DST_DIR"

          # 查找符合条件的 CN 文件
          mapfile -t FILES < <(
            find "$SRC_DIR" -type f -name "*.yaml" \
              | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|$)|(^|/)cn\.yaml$' \
              | grep -Ev '(!cn|ads)' \
              | sort
          )

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No CN YAML files found."
            exit 0
          fi

          # 保存被合并文件列表
          echo "Merged files:" > "$FILE_LIST"
          for f in "${FILES[@]}"; do
            echo "$f" >> "$FILE_LIST"
          done

          FIRST_FILE="${FILES[0]}"
          OTHER_FILES=("${FILES[@]:1}")

          # 第一个文件保留 payload:，去掉空行
          awk 'NF{print}' "$FIRST_FILE" > "$OUTPUT_FILE"

          # 其余文件去掉 payload:，去掉空行，保持原格式并追加
          if [[ ${#OTHER_FILES[@]} -gt 0 ]]; then
            for f in "${OTHER_FILES[@]}"; do
              awk 'NF && $0 !~ /^[[:space:]]*payload:/{print}' "$f" >> "$OUTPUT_FILE"
            done
          fi

          echo "Merged CN YAML saved to $OUTPUT_FILE"
          echo "List of merged files saved to $FILE_LIST"

      - name: Commit & Push merged files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"
          git add "update/cnplus_domain.yaml" "update/merged_files.txt"
          if git commit -m "Update cnplus_domain.yaml (Merged CN YAML files)"; then
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi

