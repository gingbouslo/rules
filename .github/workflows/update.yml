name: Merge CN YAML Files

on:
  workflow_dispatch:

jobs:
  merge-cn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Merge and format CN YAML files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SRC_DIR="geo/geosite"
          DST_DIR="update"
          OUTPUT_FILE="$DST_DIR/merged_cn.yaml"

          mkdir -p "$DST_DIR"

          # 查找符合条件的 CN YAML 文件
          mapfile -t FILES < <(
            find "$SRC_DIR" -type f -name "*.yaml" \
              | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|$)|(^|/)cn\.yaml$' \
              | grep -Ev '(!cn|ads)'
          )

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No CN YAML files found."
            exit 0
          fi

          echo "Merging ${#FILES[@]} CN YAML files..."

          ALL_DOMAINS=()

          clean_domain() {
            local d="$1"
            # 去掉空格、引号、首尾多余符号
            d="${d//\"/}"
            d="${d//\'/}"
            d="$(echo "$d" | sed -E 's/^[^a-zA-Z0-9+]*//; s/[^a-zA-Z0-9]*$//')"
            printf "%s" "$d"
          }

          for f in "${FILES[@]}"; do
            # 提取所有可能的域名行，忽略空行和 payload:
            while IFS= read -r line; do
              # 去掉前后空格
              line="${line#"${line%%[![:space:]]*}"}"
              line="${line%"${line##*[![:space:]]}"}"
              # 忽略空行和 payload:
              [[ -z "$line" || "$line" == "payload:" ]] && continue
              # 如果以 - 开头去掉 -
              [[ "$line" =~ ^- ]] && line="${line#- }"
              # 清洗域名
              d="$(clean_domain "$line")"
              [[ -n "$d" ]] && ALL_DOMAINS+=("$d")
            done < "$f"
          done

          # 去重并排序
          mapfile -t SORTED_DOMAINS < <(printf '%s\n' "${ALL_DOMAINS[@]}" | sort -u)

          # 写入输出文件，标准 YAML 格式，每行以 - +.开头
          {
            echo "payload:"
            for d in "${SORTED_DOMAINS[@]}"; do
              echo "  - +.$d"
            done
          } > "$OUTPUT_FILE"

          echo "Merged CN YAML saved to $OUTPUT_FILE"

      - name: Commit & Push merged file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"
          git add "$DST_DIR/merged_cn.yaml"
          if git commit -m "Merge and sort CN YAML files"; then
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi
