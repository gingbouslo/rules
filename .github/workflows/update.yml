name: Merge CN YAML Files

on:
  workflow_dispatch:

jobs:
  merge-cn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Install git sparse-checkout tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq git

      - name: Clone remote meta-rules-dat repo (sparse checkout geo/geosite)
        run: |
          REMOTE_REPO="https://github.com/MetaCubeX/meta-rules-dat.git"
          REMOTE_BRANCH="meta"
          TEMP_DIR=$(mktemp -d)

          git clone --filter=blob:none --sparse --branch $REMOTE_BRANCH $REMOTE_REPO $TEMP_DIR
          cd $TEMP_DIR
          git sparse-checkout set geo/geosite

          # 将文件复制到当前工作目录的临时源目录
          mkdir -p "$GITHUB_WORKSPACE/temp_geo"
          cp -r geo/geosite/* "$GITHUB_WORKSPACE/temp_geo/"

      - name: Merge and format CN YAML files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SRC_DIR="temp_geo"       # 从上一步复制的临时目录
          DST_DIR="update"
          OUTPUT_FILE="$DST_DIR/merged_cn.yaml"

          mkdir -p "$DST_DIR"

          # 查找符合条件的 CN YAML 文件
          mapfile -t FILES < <(
            find "$SRC_DIR" -type f -name "*.yaml" \
              | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|$)|(^|/)cn\.yaml$' \
              | grep -Ev '(!cn|ads)'
          )

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No CN YAML files found."
            exit 0
          fi

          echo "Merging ${#FILES[@]} CN YAML files..."

          ALL_DOMAINS=()

          clean_domain() {
            local d="$1"
            d="${d//\"/}"
            d="${d//\'/}"
            d="$(echo "$d" | sed -E 's/^[^a-zA-Z0-9+]*//; s/[^a-zA-Z0-9]*$//')"
            printf "%s" "$d"
          }

          for f in "${FILES[@]}"; do
            while IFS= read -r line; do
              line="${line#"${line%%[![:space:]]*}"}"
              line="${line%"${line##*[![:space:]]}"}"
              [[ -z "$line" || "$line" == "payload:" ]] && continue
              [[ "$line" =~ ^- ]] && line="${line#- }"
              d="$(clean_domain "$line")"
              [[ -n "$d" ]] && ALL_DOMAINS+=("$d")
            done < "$f"
          done

          mapfile -t SORTED_DOMAINS < <(printf '%s\n' "${ALL_DOMAINS[@]}" | sort -u)

          {
            echo "payload:"
            for d in "${SORTED_DOMAINS[@]}"; do
              echo "  - +.$d"
            done
          } > "$OUTPUT_FILE"

          echo "Merged CN YAML saved to $OUTPUT_FILE"

      - name: Commit & Push merged file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"
          git add "update/merged_cn.yaml"
          if git commit -m "Merge and sort CN YAML files from MetaCubeX/meta-rules-dat"; then
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi
