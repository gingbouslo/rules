name: Merge CN YAML Files (Fast)

on:
  workflow_dispatch:

jobs:
  merge-cn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone remote meta-rules-dat repo (sparse checkout geo/geosite)
        run: |
          REMOTE_REPO="https://github.com/MetaCubeX/meta-rules-dat.git"
          REMOTE_BRANCH="meta"
          TEMP_DIR=$(mktemp -d)

          git clone --filter=blob:none --sparse --branch $REMOTE_BRANCH $REMOTE_REPO $TEMP_DIR
          cd $TEMP_DIR
          git sparse-checkout set geo/geosite

          mkdir -p "$GITHUB_WORKSPACE/temp_geo"
          cp -r geo/geosite/* "$GITHUB_WORKSPACE/temp_geo/"

      - name: Merge CN YAML files efficiently
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          SRC_DIR="temp_geo"
          DST_DIR="update"
          OUTPUT_FILE="$DST_DIR/merged_cn.yaml"

          mkdir -p "$DST_DIR"

          # 找到符合条件的 CN 文件并按路径排序
          mapfile -t FILES < <(
            find "$SRC_DIR" -type f -name "*.yaml" \
              | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|$)|(^|/)cn\.yaml$' \
              | grep -Ev '(!cn|ads)' \
              | sort
          )

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No CN YAML files found."
            exit 0
          fi

          echo "Merging ${#FILES[@]} CN YAML files efficiently..."

          FIRST_FILE="${FILES[0]}"
          OTHER_FILES=("${FILES[@]:1}")

          # 第一个文件保留 payload:
          awk '
            /^[[:space:]]*payload:/ {print; next}
            /^[[:space:]]*$/ {next}
            {
              line=$0
              gsub(/^[[:space:]]*-\s*/,"",line)
              gsub(/["'\''"]/,"",line)
              gsub(/^[^a-zA-Z0-9+]+|[^a-zA-Z0-9]+$/,"",line)
              print "  - +."line
            }
          ' "$FIRST_FILE" > "$OUTPUT_FILE"

          # 其余文件去掉 payload: 直接追加
          if [[ ${#OTHER_FILES[@]} -gt 0 ]]; then
            awk '
              /^[[:space:]]*payload:/ {next}
              /^[[:space:]]*$/ {next}
              {
                line=$0
                gsub(/^[[:space:]]*-\s*/,"",line)
                gsub(/["'\''"]/,"",line)
                gsub(/^[^a-zA-Z0-9+]+|[^a-zA-Z0-9]+$/,"",line)
                print "  - +."line
              }
            ' "${OTHER_FILES[@]}" >> "$OUTPUT_FILE"
          fi

          echo "Merged CN YAML saved to $OUTPUT_FILE"

      - name: Commit & Push merged file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"
          git add "update/merged_cn.yaml"
          if git commit -m "Merge CN YAML files from MetaCubeX/meta-rules-dat efficiently"; then
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi
