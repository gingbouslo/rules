name: singbox-ads-合并

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"   # 每天 06:00 UTC

jobs:
  merge-ads:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Checkout MetaCubeX/meta-rules-dat (sing branch)
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: sing
          path: upstream

      - name: Merge ADS domain JSON rules
        shell: bash
        run: |
          set -euo pipefail

          SRC="upstream/geo/geosite"
          DST="update"
          OUT="${DST}/ads_domain.json"

          mkdir -p "$DST"

          FILES=()

          # 只匹配 ads 为“独立词”的 json 文件
          while IFS= read -r f; do
            FILES+=("$f")
          done < <(
            find "$SRC" -type f -name "*.json" \
              | grep -E '(^|[^a-zA-Z0-9])ads([^a-zA-Z0-9]|\.json$)'
          )

          echo "Total ADS files: ${#FILES[@]}"

          TMP="$(mktemp)"

          # 提取所有 domain_suffix，过滤空行
          for f in "${FILES[@]}"; do
            jq -r '.rules[].domain_suffix[]?' "$f" \
              | sed '/^\s*$/d' >> "$TMP"
          done

          # 从文件直接生成最终 JSON（避免参数过长）
          jq -R -s '
            split("\n")
            | map(select(length > 0))
            | {
                version: 2,
                rules: [
                  { domain_suffix: . }
                ]
              }
          ' "$TMP" > "$OUT"

          rm -f "$TMP"

      - name: Commit & push result
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          git add update/ads_domain.json

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ads_domain.json"
            git push
          fi
