name: Merge ADS JSON Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # 每天 6:00 UTC

jobs:
  merge-ads:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout MetaCubeX/meta-rules-dat (sing branch)
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: sing
          path: upstream
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge ADS JSON files
        shell: bash
        run: |
          set -euo pipefail

          SRC="upstream/geo/geosite"
          DST="$GITHUB_WORKSPACE/update"
          OUT_JSON="${DST}/foreign_domain.json"
          OUT_LIST="${DST}/foreign_domain_files.txt"

          mkdir -p "$DST"

          # 精准匹配 ads 文件名（前后为符号或边界）
          mapfile -t FILES < <(find "$SRC" -type f -name "*.json" | grep -Ei '(^|[^a-z0-9])ads([^a-z0-9]|$)' | sort)
          echo "Found ${#FILES[@]} ADS JSON files"

          # 输出来源文件名
          : > "$OUT_LIST"
          for f in "${FILES[@]}"; do
            echo "$(basename "$f")" >> "$OUT_LIST"
          done

          # 合并 domain_suffix 并去掉空行/空字符串
          TMP_DOMAINS=$(mktemp)
          for f in "${FILES[@]}"; do
            jq -r '.rules[].domain_suffix[]?' "$f" | sed '/^\s*$/d' >> "$TMP_DOMAINS"
          done

          domains_json=$(jq -R -s -c 'split("\n") | map(select(length>0))' "$TMP_DOMAINS")

          # 写入最终 JSON
          jq -n --argjson arr "$domains_json" '{version:2,rules:[{domain_suffix:$arr}]}' > "$OUT_JSON"

          echo "Merged JSON written to $OUT_JSON"

      - name: Commit & Push update/
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          git add update/foreign_domain.json update/foreign_domain_files.txt

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update foreign_domain.json (merged ADS files)"
            git push
