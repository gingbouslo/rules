name: test

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Clone meta-rules-dat (meta branch) for YAML
        run: |
          git clone --depth=1 -b meta https://github.com/MetaCubeX/meta-rules-dat.git meta

      - name: Merge YAML rules (cn / ads / foreign)
        run: |
          set -euo pipefail

          # 定义 is_exact_foreign 函数
          is_exact_foreign() {
            local f="$1"
            for e in "${EXACT_FOREIGN[@]}"; do
              [[ "$f" == "$e" ]] && return 0
            done
            return 1
          }

          process_rules() {
            sed -E '
              /^[[:space:]]*payload:/d;
              /^[[:space:]]*$/d;
              /^[[:space:]]*-[[:space:]]*DOMAIN-REGEX,/d;
              s/^[[:space:]]*-[[:space:]]*DOMAIN-SUFFIX,([^\r\n]+)/  - +.\1/;
              s/^[[:space:]]*-[[:space:]]*DOMAIN,([^\r\n]+)/  - \1/;
              s/^[[:space:]]*-[[:space:]]*/  - /;
            '
          }

          CN_OUT=mihomo-rules/cn_domain.yaml
          ADS_OUT=mihomo-rules/ads_domain.yaml
          FOREIGN_OUT=mihomo-rules/foreign_domain.yaml

          echo "payload:" > "$CN_OUT"
          echo "payload:" > "$ADS_OUT"
          echo "payload:" > "$FOREIGN_OUT"

          # 拉取并合并 ADS 规则
          echo "===== Merging ADS Rules ====="
          curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/ads.yaml | process_rules >> "$ADS_OUT"
          
          echo "===== CN FILES ====="
          find meta/geo/geosite -name '*.yaml' | while read f; do
            name=$(basename "$f")
            if [[ "$name" =~ (^|[-_])cn([.-]|$) ]] && [[ ! "$name" =~ '!cn' ]]; then
              echo "[CN] $name"
              process_rules < "$f" >> "$CN_OUT"
            fi
          done

          # 拉取并合并 direct 规则
          echo "===== Merging Direct Rules for CN ====="
          curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/direct.yaml | process_rules >> "$CN_OUT"

          echo "===== FOREIGN FILES ====="
          find meta/geo/geosite -name '*.yaml' | while read f; do
            name=$(basename "$f")
            
            # 检查是否为 foreign 文件
            if [[ "$name" =~ '!cn' ]] && [[ ! "$name" =~ 'ads' ]]; then
              echo "[FOREIGN][!cn] $name"
              process_rules < "$f" >> "$FOREIGN_OUT"
              continue
            fi
            
            # 检查是否为 exact foreign 文件
            if is_exact_foreign "$name"; then
              echo "[FOREIGN][EXACT] $name"
              process_rules < "$f" >> "$FOREIGN_OUT"
            fi
          done

          # 拉取并合并 foreign 规则
          echo "===== Merging Foreign Rules ====="
          curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/foreign.yaml | process_rules >> "$FOREIGN_OUT"

      - name: Install mihomo
        run: |
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz
          gunzip mihomo-linux-amd64-v1.19.17.gz
          mv mihomo-linux-amd64-v1.19.17 mihomo
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo

      - name: Find and convert rule files to MRS
        run: |
          RULE_DIR="mihomo-rules"

          find "$RULE_DIR" -type f \( -name "*_domain.yaml" -o -name "*_domain.text" -o -name "*_ip.yaml" -o -name "*_ip.text" \) | while read FILE; do
            BASENAME=$(basename "$FILE")
            DIRNAME=$(dirname "$FILE")

            # Determine type: domain or ip
            if [[ "$BASENAME" == *_domain.* ]]; then
              TYPE="domain"
            elif [[ "$BASENAME" == *_ip.* ]]; then
              TYPE="ipcidr"
            else
              echo "Unknown type: $FILE"
              continue
            fi

            # Determine format: yaml or text
            EXT="${BASENAME##*.}"
            if [[ "$EXT" == "yaml" ]]; then
              FORMAT="yaml"
            elif [[ "$EXT" == "text" ]]; then
              FORMAT="text"
            else
              echo "Unknown extension: $FILE"
              continue
            fi

            # Output
            OUTPUT="${FILE%.*}.mrs"

            echo "Converting $FILE → $OUTPUT"
            mihomo convert-ruleset "$TYPE" "$FORMAT" "$FILE" "$OUTPUT"
          done

      - name: Checkout meta-rules-dat (sing branch) for JSON
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: sing
          path: meta-sing

      - name: Build JSON domain rule files (cn / ads / foreign)
        shell: bash
        run: |
          set -euo pipefail

          SRC="meta-sing/geo/geosite"
          OUT_DIR="singbox-rules"
          mkdir -p "$OUT_DIR"

          ########################
          # helper: build json
          ########################
          build_json() {
            local name="$1"
            shift
            local files=("$@")
            local out="$OUT_DIR/${name}.json"

            echo
            echo "=== Building ${name}.json ==="
            echo "Source files:"
            for f in "${files[@]}"; do
              echo " - $(basename "$f")"
            done
            echo "Total files: ${#files[@]}"
            
            jq -r '.rules[].domain_suffix[]?' "${files[@]}" \
              | sed '/^$/d' \
              | sort -u > domains.txt

            # 拉取并合并 ads.json
            if [[ "$name" == "ads_domain" ]]; then
              echo "===== Merging Ads Rules ====="
              curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/ads.json | jq -r '.rules[].domain_suffix[]?' >> domains.txt
            fi

            # 拉取并合并 direct.json
            if [[ "$name" == "cn_domain" ]]; then
              echo "===== Merging Direct Rules for CN ====="
              curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/direct.json | jq -r '.rules[].domain_suffix[]?' >> domains.txt
            fi

            # 拉取并合并 foreign.json
            if [[ "$name" == "foreign_domain" ]]; then
              echo "===== Merging Foreign Rules ====="
              curl -s https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/foreign.json | jq -r '.rules[].domain_suffix[]?' >> domains.txt
            fi

            local count
            count=$(wc -l < domains.txt | tr -d ' ')
            echo "Total domains: $count"

            jq -n \
              --rawfile domains domains.txt \
              '{
                version: 2,
                rules: [
                  { domain_suffix: ($domains | split("\n") | map(select(length > 0))) }
                ]
              }' > "$out"

            rm -f domains.txt
          }

          ########################
          # 1. CN (cn 独立词，不含 !cn)
          ########################
          mapfile -t CN_FILES < <(
            find "$SRC" -type f -name "*.json" \
              | grep -Ev '!cn' \
              | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|\.json$)'
          )

          if [ "${#CN_FILES[@]}" -gt 0 ]; then
            build_json "cn_domain" "${CN_FILES[@]}"
          else
            echo "No CN files found"
          fi

          ########################
          # 2. ADS（ads 必须为独立词）
          ########################
          mapfile -t ADS_FILES < <(
            find "$SRC" -type f -name "*.json" \
              | grep -E '(^|[^a-zA-Z0-9])ads([^a-zA-Z0-9]|\.json$)'
          )

          if [ "${#ADS_FILES[@]}" -gt 0 ]; then
            build_json "ads_domain" "${ADS
