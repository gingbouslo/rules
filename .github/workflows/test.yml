name: test

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Clone meta-rules-dat (meta branch) for YAML
        run: |
          git clone --depth=1 -b meta https://github.com/MetaCubeX/meta-rules-dat.git meta

      ################################
      # Mihomo YAML merge
      ################################
      - name: Merge Mihomo YAML rules
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p mihomo-rules tmp

          CN_OUT=mihomo-rules/cn_domain.yaml
          ADS_OUT=mihomo-rules/ads_domain.yaml
          FOREIGN_OUT=mihomo-rules/foreign_domain.yaml

          echo "payload:" > "$CN_OUT"
          echo "payload:" > "$ADS_OUT"
          echo "payload:" > "$FOREIGN_OUT"

          normalize() {
            sed -E '
              /^[[:space:]]*payload:/d
              /^[[:space:]]*$/d
              /^[[:space:]]*-[[:space:]]*DOMAIN-REGEX,/d
              s/^[[:space:]]*-[[:space:]]*DOMAIN-SUFFIX,([^\r\n]+)/+.\1/
              s/^[[:space:]]*-[[:space:]]*DOMAIN,([^\r\n]+)/\1/
              s/^[[:space:]]*-[[:space:]]*//
            '
          }

          filter_valid_domains() {
            grep -E '^([a-zA-Z0-9_\-]+\.)+[a-zA-Z]{2,}$|^\+\.[a-zA-Z0-9_\-\.]+$'
          }

          # ---- CN YAML ----
          > tmp/cn.txt
          for f in $(find meta/geo/geosite -name '*cn*.yaml' ! -name '*ads*.yaml'); do
            normalize < "$f" >> tmp/cn.txt
          done

          curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/direct.yaml \
            | normalize >> tmp/cn.txt

          filter_valid_domains tmp/cn.txt | sort -u | sed 's/^/  - /' >> "$CN_OUT"

          # ---- ADS YAML ----
          > tmp/ads.txt
          for f in $(find meta/geo/geosite -name '*ads*.yaml'); do
            normalize < "$f" >> tmp/ads.txt
          done

          curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/ads.yaml \
            | normalize >> tmp/ads.txt

          filter_valid_domains tmp/ads.txt | sort -u | sed 's/^/  - /' >> "$ADS_OUT"

          # ---- FOREIGN YAML ----
          > tmp/foreign.txt
          for f in $(find meta/geo/geosite -name '*.yaml' ! -name '*cn*.yaml' ! -name '*ads*.yaml' -o -name '*!cn*.yaml'); do
            normalize < "$f" >> tmp/foreign.txt
          done

          curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/foreign.yaml \
            | normalize >> tmp/foreign.txt

          filter_valid_domains tmp/foreign.txt | sort -u | sed 's/^/  - /' >> "$FOREIGN_OUT"

      ################################
      # Install Mihomo
      ################################
      - name: Install Mihomo
        run: |
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz
          gunzip mihomo-linux-amd64-v1.19.17.gz
          chmod +x mihomo-linux-amd64-v1.19.17
          sudo mv mihomo-linux-amd64-v1.19.17 /usr/local/bin/mihomo

      - name: Convert Mihomo YAML to MRS
        run: |
          for f in mihomo-rules/*.yaml; do
            # 跳过空文件
            [ -s "$f" ] || continue
            out="${f%.yaml}.mrs"
            mihomo convert-ruleset domain yaml "$f" "$out" || echo "Skip invalid file $f"
          done

      ################################
      # Sing-box JSON merge
      ################################
      - name: Checkout meta-rules-dat (sing branch)
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: sing
          path: meta-sing

      - name: Build sing-box JSON rules
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p singbox-rules tmp

          SRC=meta-sing/geo/geosite
          OUT=singbox-rules

          build_json() {
            local out="$1"; shift
            > tmp/file.txt
            for f in "$@"; do
              jq -r '.rules[].domain_suffix[]?' "$f" >> tmp/file.txt
            done
            # 添加远程合并
            case "$out" in
              cn_domain.json)
                curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/cnplus_domain.json \
                  | jq -r '.rules[].domain_suffix[]?' >> tmp/file.txt ;;
              ads_domain.json)
                curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/ads.json \
                  | jq -r '.rules[].domain_suffix[]?' >> tmp/file.txt ;;
              foreign_domain.json)
                curl -fsSL https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/foreign.json \
                  | jq -r '.rules[].domain_suffix[]?' >> tmp/file.txt ;;
            esac
            sort -u tmp/file.txt > tmp/file.final
            jq -n --rawfile d tmp/file.final '{
              version: 2,
              rules: [{ domain_suffix: ($d | split("\n") | map(select(length>0))) }]
            }' > "$OUT/$out"
          }

          # CN JSON
          mapfile -t CN_FILES < <(find "$SRC" -name '*.json' | grep -Ev '!cn' | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|\.json$)')
          [ "${#CN_FILES[@]}" -gt 0 ] && build_json cn_domain.json "${CN_FILES[@]}"

          # ADS JSON
          mapfile -t ADS_FILES < <(find "$SRC" -name '*.json' | grep -E '(^|[^a-zA-Z0-9])ads([^a-zA-Z0-9]|\.json$)')
          [ "${#ADS_FILES[@]}" -gt 0 ] && build_json ads_domain.json "${ADS_FILES[@]}"

          # FOREIGN JSON
          mapfile -t FOREIGN_FILES < <(find "$SRC" -name '*.json' | grep '!cn' | grep -Ev 'ads')
          [ "${#FOREIGN_FILES[@]}" -gt 0 ] && build_json foreign_domain.json "${FOREIGN_FILES[@]}"

      ################################
      # Commit changes
      ################################
      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add mihomo-rules singbox-rules
          git diff --cached --quiet || git commit -m "Update rules"
          git push
