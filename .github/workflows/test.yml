name: Merge and Generate All Rules

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Clone meta-rules-dat (meta branch) for YAML
        run: |
          git clone --depth=1 -b meta https://github.com/MetaCubeX/meta-rules-dat.git meta

      ################################
      # Mihomo YAML merge
      ################################
      - name: Merge Mihomo YAML rules
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p mihomo-rules tmp

          CN_OUT=mihomo-rules/cn_domain.yaml
          ADS_OUT=mihomo-rules/ads_domain.yaml
          FOREIGN_OUT=mihomo-rules/foreign_domain.yaml

          echo "payload:" > "$CN_OUT"
          echo "payload:" > "$ADS_OUT"
          echo "payload:" > "$FOREIGN_OUT"

          normalize() {
            sed -E '
              /^[[:space:]]*payload:/d
              /^[[:space:]]*$/d
              /^[[:space:]]*-[[:space:]]*DOMAIN-REGEX,/d
              s/^[[:space:]]*-[[:space:]]*DOMAIN-SUFFIX,([^\r\n]+)/+.\1/
              s/^[[:space:]]*-[[:space:]]*DOMAIN,([^\r\n]+)/\1/
              s/^[[:space:]]*-[[:space:]]*//
            '
          }

          echo "===== CN FILES ====="
          find meta/geo/geosite -name '*.yaml' | while read -r f; do
            name=$(basename "$f")
            if [[ "$name" =~ (^|[-_])cn([.-]|$) ]] && [[ ! "$name" =~ '!cn' ]]; then
              echo "[CN] $name"
              normalize < "$f" >> tmp/cn.txt
            fi
          done

          echo "===== Merging Direct Rules for CN ====="
          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/diretc.yaml \
            | normalize >> tmp/cn.txt

          sort -u tmp/cn.txt | sed 's/^/  - /' >> "$CN_OUT"

          echo "===== ADS FILES ====="
          find meta/geo/geosite -name '*.yaml' | while read -r f; do
            name=$(basename "$f")
            if [[ "$name" =~ (^|[-_])ads([.-]|$) ]]; then
              echo "[ADS] $name"
              normalize < "$f" >> tmp/ads.txt
            fi
          done

          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/ads.yaml \
            | normalize >> tmp/ads.txt

          sort -u tmp/ads.txt | sed 's/^/  - /' >> "$ADS_OUT"

          echo "===== FOREIGN FILES ====="
          find meta/geo/geosite -name '*.yaml' | while read -r f; do
            name=$(basename "$f")
            if [[ "$name" =~ '!cn' ]] && [[ ! "$name" =~ 'ads' ]]; then
              echo "[FOREIGN] $name"
              normalize < "$f" >> tmp/foreign.txt
            fi
          done

          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/mihomo-rules/foreign.yaml \
            | normalize >> tmp/foreign.txt

          sort -u tmp/foreign.txt | sed 's/^/  - /' >> "$FOREIGN_OUT"

      ################################
      # Install mihomo
      ################################
      - name: Install mihomo
        run: |
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz
          gunzip mihomo-linux-amd64-v1.19.17.gz
          chmod +x mihomo-linux-amd64-v1.19.17
          sudo mv mihomo-linux-amd64-v1.19.17 /usr/local/bin/mihomo

      - name: Convert Mihomo YAML to MRS
        run: |
          for f in mihomo-rules/*.yaml; do
            out="${f%.yaml}.mrs"
            mihomo convert-ruleset domain yaml "$f" "$out"
          done

      ################################
      # Sing-box JSON merge
      ################################
      - name: Checkout meta-rules-dat (sing branch)
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: sing
          path: meta-sing

      - name: Build sing-box JSON rules
        shell: bash
        run: |
          set -euo pipefail

          SRC=meta-sing/geo/geosite
          OUT=singbox-rules
          mkdir -p "$OUT" tmp

          extract_domains() {
            jq -r '.rules[].domain_suffix[]?' "$@"
          }

          echo "===== CN JSON ====="
          find "$SRC" -name '*.json' | grep -Ev '!cn' | grep -E '(^|[^a-zA-Z0-9])cn([^a-zA-Z0-9]|\.json$)' \
            | xargs extract_domains >> tmp/cn.json.txt

          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/direct.json \
            | jq -r '.rules[].domain_suffix[]?' >> tmp/cn.json.txt

          sort -u tmp/cn.json.txt > tmp/cn.final

          jq -n --rawfile d tmp/cn.final '{
            version: 2,
            rules: [{ domain_suffix: ($d | split("\n") | map(select(length>0))) }]
          }' > "$OUT/cn_domain.json"

          echo "===== ADS JSON ====="
          find "$SRC" -name '*.json' | grep -E '(^|[^a-zA-Z0-9])ads([^a-zA-Z0-9]|\.json$)' \
            | xargs extract_domains >> tmp/ads.json.txt

          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/ads.json \
            | jq -r '.rules[].domain_suffix[]?' >> tmp/ads.json.txt

          sort -u tmp/ads.json.txt > tmp/ads.final

          jq -n --rawfile d tmp/ads.final '{
            version: 2,
            rules: [{ domain_suffix: ($d | split("\n") | map(select(length>0))) }]
          }' > "$OUT/ads_domain.json"

          echo "===== FOREIGN JSON ====="
          find "$SRC" -name '*.json' | grep '!cn' | grep -Ev 'ads' \
            | xargs extract_domains >> tmp/foreign.json.txt

          curl -fsSL \
            https://raw.githubusercontent.com/evecus/files/refs/heads/main/singbox-rules/foreign.json \
            | jq -r '.rules[].domain_suffix[]?' >> tmp/foreign.json.txt

          sort -u tmp/foreign.json.txt > tmp/foreign.final

          jq -n --rawfile d tmp/foreign.final '{
            version: 2,
            rules: [{ domain_suffix: ($d | split("\n") | map(select(length>0))) }]
          }' > "$OUT/foreign_domain.json"

      ################################
      # Compile SRS
      ################################
      - name: Install sing-box
        run: |
          VER=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r .tag_name | sed 's/v//')
          wget -q https://github.com/SagerNet/sing-box/releases/download/v$VER/sing-box-$VER-linux-amd64.tar.gz
          tar -xzf sing-box-$VER-linux-amd64.tar.gz

      - name: Compile JSON to SRS
        run: |
          cd singbox-rules
          for f in *.json; do
            ../sing-box-*/sing-box rule-set compile "$f"
          done

      ################################
      # Commit
      ################################
      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add .
          git diff --cached --quiet || git commit -m "Update rules"
          git push
